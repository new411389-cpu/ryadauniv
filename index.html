<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="theme-color" content="#0056b3">
    <title>نظام الصيانة الذكي - جامعة الريادة</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* ==========================================================================
           1. ROOT VARIABLES & PALETTE (لوحة الألوان والمتغيرات)
           ==========================================================================
        */
        :root {
            /* الألوان الأساسية */
            --primary: #0056b3;        
            --primary-dark: #003366;   
            --primary-soft: #e3f2fd;
            --accent: #0ea5e9;
            
            /* ألوان الخلفيات */
            --bg-body: #f3f4f6;            
            --bg-card: #ffffff;        
            --bg-input: #f9fafb;
            
            /* ألوان النصوص */
            --text-main: #111827;            
            --text-secondary: #6b7280;      
            --text-light: #9ca3af;
            
            /* ألوان الحالات (Status) */
            --gold: #f59e0b;            
            --gold-light: #fef3c7;
            --success: #10b981;        
            --success-bg: #ecfdf5;
            --danger: #ef4444;            
            --danger-bg: #fef2f2;
            --warning: #f97316;        
            --info: #3b82f6;            
            
            /* الصور والمؤثرات */
            --bg-image: url('https://a.top4top.io/p_36115ao3o1.jpg');
            
            /* الظلال (Shadows) */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-glow: 0 0 15px rgba(0, 86, 179, 0.3);
            
            /* الحدود والانحناءات */
            --border-color: #e5e7eb;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 30px;
        }
        
        /* تصفير الإعدادات الافتراضية */
        * { 
            box-sizing: border-box; 
            outline: none; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; 
            padding: 0; 
        }
        
        /* إعدادات الجسم الرئيسية */
        body {
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            min-height: 100vh;
            background-image: linear-gradient(
                rgba(243,244,246,0.92), 
                rgba(243,244,246,0.92)
            ), var(--bg-image);
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed;
            overflow-x: hidden;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        /* الحاوية الرئيسية للهاتف */
        .app-wrapper { 
            max-width: 550px; 
            margin: 0 auto; 
            min-height: 100vh; 
            position: relative; 
            padding-bottom: 100px; 
            background: transparent;
        }

        .hidden { display: none !important; }
        
        /* ==========================================================================
           2. HEADER & BANNER STYLES (تصميم البانر والهيدر الجديد)
           ==========================================================================
        */
        .main-banner {
            height: 220px; 
            /* تخفيف التدرج اللوني لإظهار الجامعة */
            background: linear-gradient(
                to bottom, 
                rgba(0, 50, 100, 0.2), 
                rgba(0, 20, 50, 0.8)
            ), url('https://a.top4top.io/p_36115ao3o1.jpg');
            background-size: cover; 
            background-position: center;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            padding: 20px 25px;
            border-bottom-left-radius: var(--radius-xl); 
            border-bottom-right-radius: var(--radius-xl); 
            margin-bottom: 25px; 
            box-shadow: var(--shadow-lg); 
            position: relative;
            z-index: 10;
        }

        .header-top {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }

        .header-bottom {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
        }

        /* تنسيق بروفايل المستخدم العائم */
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px 8px 8px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            transition: 0.3s;
            cursor: pointer;
        }
        
        .user-profile-header:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.25);
        }

        .user-avatar-header {
            width: 50px;
            height: 50px;
            position: relative;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .user-avatar-header img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info-text {
            display: flex;
            flex-direction: column;
        }

        .user-info-text h1 {
            font-size: 16px;
            color: white;
            font-weight: 800;
            margin: 0;
            line-height: 1.2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .role-badge-header {
            color: rgba(255,255,255,0.9);
            font-size: 11px;
            font-weight: 600;
        }

        /* زر الإشعارات */
        .bell-btn {
            background: rgba(255,255,255,0.2); 
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; 
            color: white; backdrop-filter: blur(5px); 
            border: 1px solid rgba(255,255,255,0.3);
            transition: 0.2s;
            cursor: pointer;
        }
        .bell-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.3); }
        .bell-badge {
            position: absolute; top: 10px; right: 8px; width: 8px; height: 8px;
            background: var(--danger); border-radius: 50%; display: none;
            border: 1px solid #fff;
        }

        .banner-id-tag {
            color: rgba(255,255,255,0.8); 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            background: rgba(0,0,0,0.4); 
            padding: 4px 8px; 
            border-radius: 6px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* ==========================================================================
           3. MODERN REQUEST CARDS (تصميم بطاقات البلاغات الاحترافي)
           ==========================================================================
        */
        .request-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg);
            margin-bottom: 16px; 
            border: 1px solid white; 
            box-shadow: var(--shadow-sm); 
            transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1); 
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .request-card:active { transform: scale(0.98); }
        .request-card:hover { 
            transform: translateY(-3px); 
            box-shadow: var(--shadow-md); 
            border-color: var(--primary-soft); 
        }

        /* الشريط الملون الجانبي للحالة */
        .card-status-bar {
            position: absolute;
            right: 0; top: 0; bottom: 0; width: 6px;
        }
        .st-bar-pending { background: var(--info); }
        .st-bar-done { background: var(--success); }
        .st-bar-rejected { background: var(--danger); }
        .st-bar-working { background: var(--warning); }
        .st-bar-approved { background: var(--primary); }

        .card-body { padding: 18px 20px 18px 18px; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .card-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-avatar {
            width: 42px; height: 42px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--bg-body);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .card-meta {
            display: flex;
            flex-direction: column;
        }

        .user-name { font-size: 14px; font-weight: 700; color: var(--text-main); }
        
        /* كود البلاغ المودرن (Ticket ID) */
        .ticket-code { 
            font-family: 'Courier New', monospace; 
            font-size: 13px; 
            color: var(--primary); 
            font-weight: 800; 
            background: var(--primary-soft);
            padding: 2px 8px;
            border-radius: 6px;
            width: fit-content;
            margin-top: 2px;
            letter-spacing: 1px;
            border: 1px solid rgba(0, 86, 179, 0.1);
        }

        .time-tag {
            font-size: 11px;
            color: var(--text-light);
            background: var(--bg-body);
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .card-content { margin-bottom: 15px; }

        .request-desc {
            font-size: 14px;
            color: var(--text-main);
            line-height: 1.6;
            font-weight: 500;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            font-size: 11px;
            padding: 5px 12px;
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            border: 1px solid var(--border-color);
        }
        .tag i { color: var(--primary); font-size: 10px; }
        
        .tag-priority-high { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .tag-priority-high i { color: #dc2626; }
        
        .card-footer {
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-text {
            font-size: 12px; 
            font-weight: 800; 
            display: flex; 
            align-items: center; 
            gap: 5px;
        }
        
        .st-txt-pending { color: var(--info); }
        .st-txt-done { color: var(--success); }
        .st-txt-rejected { color: var(--danger); }
        .st-txt-working { color: var(--warning); }

        /* ==========================================================================
           4. MODERN BUTTONS & INPUTS (الأزرار الصغيرة والمنظمة)
           ==========================================================================
        */
        .btn-main {
            width: 100%;
            padding: 12px 20px; /* تصغير الحواف */
            background: var(--primary);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 86, 179, 0.2);
            transition: all 0.2s;
        }
        .btn-main:active { transform: scale(0.97); box-shadow: none; }
        .btn-main:disabled { opacity: 0.7; cursor: not-allowed; }
        
        /* أزرار صغيرة ومنظمة للبطاقات */
        .btn-sm {
            padding: 6px 14px;
            font-size: 11px;
            border-radius: 8px;
            min-height: 32px;
            width: auto;
            box-shadow: none;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }
        .btn-ghost:hover { background: var(--bg-input); color: var(--text-main); }
        
        .btn-danger { background: var(--danger); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); }

        /* Modern Select & Inputs */
        .input-group { margin-bottom: 20px; position: relative; }
        .input-group label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 700; }
        
        input, textarea, .modern-select {
            width: 100%;
            padding: 12px 16px;
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-main);
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
            font-weight: 600;
            transition: 0.2s;
            box-shadow: var(--shadow-xs);
        }
        
        /* تصميم القائمة المنسدلة الاحترافي (سهم مخصص) */
        select.modern-select {
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230056b3' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 15px center;
            background-size: 16px;
            padding-left: 45px !important;
            cursor: pointer;
        }
        
        input:focus, textarea:focus, .modern-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
            background-color: #fff;
        }

        /* ==========================================================================
           5. AUTH & LAYOUT (تنسيق شاشة الدخول والتخطيط)
           ==========================================================================
        */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-md);
            border: 1px solid white;
            backdrop-filter: blur(12px);
            margin-bottom: 20px;
        }

        .auth-logo-modern {
            width: 85px; height: 85px; border-radius: 22px;
            margin-bottom: 15px; object-fit: cover;
            box-shadow: var(--shadow-lg);
        }

        .auth-card {
            background: #fff;
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 14px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .auth-card:hover { transform: translateY(-2px); border-color: var(--primary-soft); }
        .auth-card-input:checked + .auth-card {
            background: var(--primary-soft);
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: inset 0 0 0 1px var(--primary);
        }
        .auth-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }

        /* Priority Select */
        .priority-grid { display: flex; gap: 10px; }
        .prio-card {
            flex: 1; padding: 10px; background: #fff; border: 1px solid var(--border-color);
            border-radius: 12px; text-align: center; cursor: pointer; color: var(--text-secondary);
            font-size: 12px; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .prio-radio:checked + .prio-card.p-low { background: #ecfdf5; border-color: var(--success); color: var(--success); }
        .prio-radio:checked + .prio-card.p-med { background: #fff7ed; border-color: var(--warning); color: var(--warning); }
        .prio-radio:checked + .prio-card.p-high { background: #fef2f2; border-color: var(--danger); color: var(--danger); }

        /* Loader */
        #loader {
            position: fixed; inset: 0; background: var(--bg-body);
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        /* ==========================================================================
           6. NAV & OTHER ELEMENTS (التنقل وباقي العناصر)
           ==========================================================================
        */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; max-width: 550px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.96); backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 8px 25px 25px; z-index: 900;
            border-top-left-radius: 30px; border-top-right-radius: 30px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.06);
        }
        .nav-item { text-align: center; color: #9ca3af; font-size: 10px; cursor: pointer; width: 65px; transition: 0.2s; }
        .nav-item i { font-size: 22px; margin-bottom: 5px; display: block; transition: 0.2s; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-item.active i { transform: translateY(-4px); }
        
        .nav-add-btn {
            width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 24px; box-shadow: 0 10px 25px rgba(0,86,179,0.35);
            transform: translateY(-30px); border: 5px solid var(--bg-body);
            cursor: pointer;
        }
        .nav-add-btn:active { transform: translateY(-25px); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { width: 100%; max-width: 420px; background: #fff; border-radius: 30px; padding: 30px; max-height: 85vh; overflow-y: auto; position: relative; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .close-btn { position: absolute; top: 20px; left: 20px; width: 35px; height: 35px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: var(--text-secondary); transition: 0.2s; }
        .close-btn:hover { background: var(--danger); color: white; }

        /* Tabs */
        .tabs-container { display: flex; margin: 15px 0; background: #e5e7eb; padding: 5px; border-radius: 18px; }
        .tab-btn { flex: 1; padding: 10px; font-size: 13px; border-radius: 14px; border: none; background: transparent; color: #6b7280; font-weight: 700; cursor: pointer; font-family: 'Cairo'; transition: 0.2s; }
        .tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .mic-btn { width: 65px; height: 65px; border-radius: 50%; background: #fff; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 22px; color: var(--text-secondary); cursor: pointer; transition: 0.2s; }
        .mic-btn:active { transform: scale(0.95); }
        .mic-btn.recording { border-color: var(--danger); color: var(--danger); background: #fef2f2; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); } 70% { box-shadow: 0 0 0 12px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } }

        /* Media & Files */
        .media-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .media-item { aspect-ratio: 1; border-radius: 14px; background: #eee; position: relative; overflow: hidden; border: 1px solid var(--border-color); }
        .media-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-file { position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: rgba(239, 68, 68, 0.9); color: white; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* User Profile & Frames */
        .frame-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .frame-option { aspect-ratio: 1; border-radius: 50%; border: 2px solid #eee; cursor: pointer; position: relative; }
        .frame-option.selected { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
        
    </style>
</head>
<body>

<div class="app-wrapper">
    <audio id="notify-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="loader">
        <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:var(--primary);"></i>
        <h3 style="margin-top:20px; color:var(--primary-dark); font-weight:800;">جامعة الريادة</h3>
        <p style="color:var(--text-light); font-size:14px;">نظام الصيانة الذكي</p>
    </div>

    <div id="auth-screen" class="hidden" style="min-height:100vh; display:flex; flex-direction:column; justify-content:center; padding:25px;">
        <div class="glass-card" style="text-align:center;">
            <img src="https://a.top4top.io/p_36115ao3o1.jpg" style="width:95px; height:95px; border-radius:24px; box-shadow:0 15px 30px rgba(0,0,0,0.1); margin-bottom:25px;">
            <h2 style="color:var(--primary-dark); font-weight:800; margin-bottom:5px;">أهلاً بك</h2>
            <p style="color:var(--text-secondary); font-size:14px; margin-bottom:35px;">سجل الدخول للمتابعة إلى النظام</p>

            <div id="reg-fields" class="hidden">
                <div class="auth-grid" style="grid-template-columns: 1fr 1fr;">
                    <label><input type="radio" name="auth-gender" value="male" class="auth-card-input" checked><div class="auth-card"><i class="fa-solid fa-person"></i><span>ذكر</span></div></label>
                    <label><input type="radio" name="auth-gender" value="female" class="auth-card-input"><div class="auth-card"><i class="fa-solid fa-person-dress"></i><span>أنثى</span></div></label>
                </div>
                <div class="input-group"><input type="text" id="reg-name" placeholder="الاسم الكامل"></div>
                <div class="input-group"><input type="tel" id="reg-phone" placeholder="رقم الهاتف"></div>
                
                <p style="text-align:right; font-size:12px; font-weight:bold; margin:15px 0 8px; color:var(--primary);">حدد الوظيفة:</p>
                <div class="auth-grid" style="grid-template-columns: repeat(3, 1fr); gap: 8px;">
                    <label><input type="radio" name="auth-role" value="employee" class="auth-card-input" checked><div class="auth-card"><i class="fa-solid fa-user"></i><span style="font-size:10px;">موظف</span></div></label>
                    <label><input type="radio" name="auth-role" value="supervisor" class="auth-card-input"><div class="auth-card"><i class="fa-solid fa-user-tie"></i><span style="font-size:10px;">مشرف</span></div></label>
                    <label><input type="radio" name="auth-role" value="technician" class="auth-card-input"><div class="auth-card"><i class="fa-solid fa-helmet-safety"></i><span style="font-size:10px;">مهندس</span></div></label>
                    <label><input type="radio" name="auth-role" value="worker" class="auth-card-input"><div class="auth-card" style="border-color:var(--gold); color:var(--gold);"><i class="fa-solid fa-wrench"></i><span style="font-size:10px;">فني</span></div></label>
                    <label><input type="radio" name="auth-role" value="manager" class="auth-card-input"><div class="auth-card"><i class="fa-solid fa-shield-halved"></i><span style="font-size:10px;">مدير</span></div></label>
                </div>
                <div class="input-group"><input type="text" id="reg-job" placeholder="المسمى الوظيفي"></div>
                <div class="input-group"><input type="text" id="reg-loc" placeholder="مقر العمل"></div>
            </div>

            <div class="input-group"><input type="email" id="email" placeholder="البريد الإلكتروني"></div>
            <div class="input-group"><input type="password" id="password" placeholder="كلمة المرور"></div>
            <div id="confirm-pass-field" class="hidden input-group"><input type="password" id="confirm-password" placeholder="تأكيد كلمة المرور"></div>
            
            <button onclick="handleAuth()" id="auth-btn" class="btn-main" style="margin-top:20px;">تسجيل الدخول</button>
            <div onclick="toggleAuth()" style="margin-top:25px; font-size:13px; cursor:pointer; color:var(--text-secondary);">
                <span id="auth-switch-text">ليس لديك حساب؟ <b style="color:var(--primary)">إنشاء حساب جديد</b></span>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="main-banner">
            <div class="header-top">
                <div class="bell-btn" onclick="toast('لا توجد إشعارات جديدة')">
                    <i class="fa-regular fa-bell"></i>
                    <div class="bell-badge"></div>
                </div>
            </div>
            
            <div class="header-bottom">
                <div class="user-profile-header" onclick="nav('profile', document.querySelector('.nav-item:nth-child(4)'))">
                    <div class="user-avatar-header">
                        <img id="banner-img" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
                        <div id="banner-frame" class="frame-overlay"></div>
                    </div>
                    <div class="user-info-text">
                        <h1 id="banner-name">User Name</h1>
                        <span id="banner-role" class="role-badge-header">Role</span>
                    </div>
                </div>
                <div style="text-align:left;">
                    <span id="banner-id" class="banner-id-tag">ID: --</span>
                </div>
            </div>
        </div>
        
        <div id="main-content">
            <div id="page-home" class="page-section">
                <div style="padding:0 20px;">
                    <div class="tabs-container">
                        <button class="tab-btn active" onclick="switchTab('active', this)">المهام الجارية</button>
                        <button class="tab-btn" onclick="switchTab('history', this)">الأرشيف</button>
                        <button class="tab-btn" onclick="switchTab('trash', this)" style="color:var(--danger);">سلة المحذوفات</button>
                    </div>
                    
                    <div id="filter-container" class="hidden" style="margin-bottom:20px;">
                        <select id="feed-filter" onchange="renderFeed()" class="modern-select">
                            <option value="all">كل المواقع</option>
                            <option value="Admin">المبني الاداري</option>
                            <option value="Nursing">كلية التمريض</option>
                            <option value="CS">حاسبات ومعلومات</option>
                            <option value="PT">علاج طبيعي</option>
                            <option value="Pharmacy">صيدلة</option>
                            <option value="Dentistry">طب الأسنان</option>
                            <option value="Business">إدارة أعمال</option>
                        </select>
                    </div>
                    
                    <div id="archive-actions" class="hidden" style="margin-bottom:20px;">
                         <button onclick="downloadArchivePDF()" class="btn-main btn-sm" style="background:var(--success); width:100%;"><i class="fa-solid fa-file-pdf"></i> تحميل تقرير الأرشيف</button>
                    </div>
                    
                    <div id="requests-feed"></div>
                </div>
            </div>
            
            <div id="page-news" class="page-section hidden">
                <div style="padding:20px;">
                    <h3 style="color:var(--primary); margin-bottom:25px; font-weight:800; padding-right:10px; border-right:4px solid var(--gold);">البيان (أخبار الجامعة)</h3>
                    <div id="create-post-container" class="hidden" style="margin-bottom:25px;">
                        <textarea id="new-post-content" rows="3" placeholder="اكتب خبراً جديداً..."></textarea>
                        <button onclick="createPost()" class="btn-main btn-sm" style="margin-top:10px;">نشر</button>
                    </div>
                    <div id="news-feed"></div>
                </div>
            </div>

            <div id="page-create" class="page-section hidden">
                <div style="padding:20px;">
                    <div class="glass-card" style="background:#fff; margin:0; padding:25px;">
                        <h3 style="margin:0 0 25px; color:var(--primary-dark); border-right:5px solid var(--primary); padding-right:12px;">بلاغ صيانة جديد</h3>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:15px;">
                            <div class="input-group">
                                <label>التاريخ</label>
                                <input type="date" id="req-date">
                            </div>
                            <div class="input-group">
                                <label>الوقت</label>
                                <input type="time" id="req-time">
                            </div>
                        </div>

                        <div class="input-group">
                            <label>نوع العطل</label>
                            <select id="req-type" class="modern-select">
                                <option value="">اختر التخصص...</option>
                                <option value="كهرباء">كهرباء</option>
                                <option value="سباكة">سباكة</option>
                                <option value="نجارة">نجارة</option>
                                <option value="تكييف">تكييف وتبريد</option>
                                <option value="IT">IT ودعم فني</option>
                                <option value="نظافة">نظافة</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label>الأهمية</label>
                            <div class="priority-grid">
                                <label class="prio-label" style="flex:1">
                                    <input type="radio" name="prio" value="low" class="prio-radio" checked style="display:none">
                                    <div class="prio-card p-low"><i class="fa-regular fa-face-smile"></i> عادي</div>
                                </label>
                                <label class="prio-label" style="flex:1">
                                    <input type="radio" name="prio" value="medium" class="prio-radio" style="display:none">
                                    <div class="prio-card p-med"><i class="fa-regular fa-face-meh"></i> متوسط</div>
                                </label>
                                <label class="prio-label" style="flex:1">
                                    <input type="radio" name="prio" value="high" class="prio-radio" style="display:none">
                                    <div class="prio-card p-high"><i class="fa-solid fa-fire"></i> عاجل</div>
                                </label>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>الموقع (إجباري)</label>
                            <select id="req-faculty" class="modern-select" style="margin-bottom:12px;">
                                <option value="">اختر المبنى...</option>
                                <option value="Admin">المبني الاداري</option>
                                <option value="Nursing">مبني كلية التمريض</option>
                                <option value="CS">مبني كليه الحاسبات والمعلومات</option>
                                <option value="PT">مبني كلية العلاج الطبيعي</option>
                                <option value="Pharmacy">مبني كليه الصيدلة</option>
                                <option value="Dentistry">مبني كلية الاسنان</option>
                                <option value="Business">مبني كلية ادراة اعمال</option>
                                <option value="Other">موقع آخر...</option>
                            </select>
                            
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                                <select id="req-floor" class="modern-select">
                                    <option value="">الدور...</option>
                                    <option value="G">الأرضي G</option>
                                    <option value="1">الأول</option>
                                    <option value="2">الثاني</option>
                                    <option value="3">الثالث</option>
                                    <option value="4">الرابع</option>
                                    <option value="Roof">السطح</option>
                                    <option value="Ext">ساحة خارجية</option>
                                </select>
                                <input type="text" id="req-room" placeholder="رقم القاعة">
                            </div>
                        </div>

                        <div class="input-group">
                            <label>وصف المشكلة</label>
                            <textarea id="req-desc" rows="4" placeholder="اكتب تفاصيل العطل بدقة..."></textarea>
                        </div>
                        
                        <div style="display:flex; gap:12px; margin-bottom:25px;">
                            <div style="flex:1; background:var(--bg-input); padding:20px; border-radius:16px; border:2px dashed var(--border-color); text-align:center; cursor:pointer;" onclick="document.getElementById('req-files').click()">
                                <i class="fa-solid fa-paperclip" style="color:var(--text-secondary); margin-bottom:5px;"></i> 
                                <p style="font-size:11px; margin:0;">إرفاق صور/فيديو</p>
                                <input type="file" id="req-files" hidden multiple accept="image/*,video/*" onchange="handleFiles(this)">
                            </div>
                            <div id="mic-trigger" class="mic-btn" onclick="toggleRecording()">
                                <i class="fa-solid fa-microphone"></i>
                            </div>
                        </div>
                        
                        <div id="preview-grid" class="media-grid" style="margin-bottom:25px;"></div>
                        <button onclick="openSupModal()" class="btn-main">التالي <i class="fa-solid fa-arrow-left"></i></button>
                    </div>
                </div>
            </div>

            <div id="page-team" class="page-section hidden">
                <div style="padding:20px;">
                    <h3 style="margin-bottom:20px; color:var(--text-main); font-weight:800;">فريق العمل</h3>
                    <div style="display:flex; gap:10px; margin-bottom:25px;">
                        <input type="text" id="search-query" placeholder="بحث بالـ ID..." style="margin:0;">
                        <button onclick="searchUser()" class="btn-main btn-sm"><i class="fa-solid fa-search"></i></button>
                    </div>
                    <div id="search-results" class="hidden" style="margin-bottom:20px;"></div>
                    <div id="friend-reqs" class="hidden" style="background:#fffbeb; padding:15px; border-radius:16px; margin-bottom:25px; border:1px solid var(--gold);">
                        <h5 style="margin:0 0 10px; color:var(--gold); font-size:13px;">طلبات صداقة جديدة:</h5>
                        <div id="reqs-list"></div>
                    </div>
                    <div id="team-list"></div>
                </div>
            </div>
           <div id="page-profile" class="page-section hidden">
                <div style="padding: 20px;">
                    <div class="glass-card" style="text-align: center;">
                        
                        <div class="user-avatar-container" style="margin: 0 auto 25px; width: 110px; height: 110px; cursor: default;">
                            <img id="edit-current-pic" src="">
                            <div id="edit-frame-overlay" class="frame-overlay"></div>
                            
                            <div onclick="document.getElementById('edit-profile-file').click()" 
                                 style="position: absolute; bottom: 0; right: 0; background: var(--primary); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s;">
                                <i class="fa-solid fa-camera" style="color: white; font-size: 16px;"></i>
                            </div>
                        </div>
                        
                        <input type="file" id="edit-profile-file" hidden accept="image/*" onchange="previewProfilePic(this)">
                        
                        <div style="background: var(--bg-body); padding: 15px; border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--border-color);">
                             <p style="font-size: 12px; font-weight: 700; color: var(--text-secondary); margin-bottom: 10px; text-align: right;">
                                 <i class="fa-solid fa-paintbrush"></i> اختر إطار للصورة:
                             </p>
                             <div class="frame-grid">
                                 <div class="frame-option f-none selected" onclick="selectFrame(this, '')">بدون</div>
                                 <div class="frame-option f-gold" onclick="selectFrame(this, 'f-gold')"></div>
                                 <div class="frame-option f-blue" onclick="selectFrame(this, 'f-blue')"></div>
                                 <div class="frame-option f-grad" onclick="selectFrame(this, 'f-grad')"><div class="f-grad-in"></div></div>
                             </div>
                        </div>

                        <div style="background: #1f2937; color: #fff; padding: 8px 20px; border-radius: 30px; display: inline-flex; align-items: center; gap: 10px; font-family: 'Courier New'; font-weight: bold; margin-bottom: 30px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" onclick="copyId()">
                            <span>ID: <span id="edit-id-display">--</span></span>
                            <i class="fa-regular fa-copy" style="font-size: 12px; opacity: 0.7;"></i>
                        </div>

                        <div style="text-align: right;">
                            <div class="input-group">
                                <label>الاسم الكامل</label>
                                <input type="text" id="edit-name">
                            </div>
                            
                            <div class="input-group">
                                <label>النوع</label>
                                <select id="edit-gender" class="modern-select">
                                    <option value="male">ذكر</option>
                                    <option value="female">أنثى</option>
                                </select>
                            </div>
                            
                            <div class="input-group">
                                <label>رقم الهاتف</label>
                                <input type="tel" id="edit-phone">
                            </div>
                            
                            <div class="input-group">
                                <label>المسمى الوظيفي</label>
                                <input type="text" id="edit-job">
                            </div>
                            
                            <div class="input-group">
                                <label>مقر العمل</label>
                                <input type="text" id="edit-loc">
                            </div>
                        </div>
                        
                        <button onclick="saveProfile()" class="btn-main" id="save-profile-btn" style="margin-top: 20px;">
                            حفظ التعديلات <i class="fa-solid fa-check"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="page-settings" class="page-section hidden">
                <div style="padding: 20px;">
                    <div class="glass-card">
                        <h3 style="margin-bottom: 25px; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                            <i class="fa-solid fa-gear" style="color: var(--primary);"></i> الإعدادات العامة
                        </h3>
                        
                        <div class="input-group">
                            <label>التنبيهات والإشعارات</label>
                            <div style="display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color);">
                                <span style="font-weight: 600; font-size: 13px;">تفعيل التنبيهات الصوتية</span>
                                <button onclick="reqNotifyPerm()" class="btn-sm btn-main" style="width: auto;">تفعيل</button>
                            </div>
                        </div>
                        
                        <div id="emp-report-btn-container" class="hidden" style="margin-top: 20px;">
                            <button onclick="openEmpReportModal()" class="btn-main" style="background: var(--info);">
                                <i class="fa-solid fa-file-contract"></i> إنشاء تقرير إداري
                            </button>
                        </div>

                        <div id="full-report-btn-container" class="hidden" style="margin-top: 20px;">
                            <button onclick="generateFullReport()" class="btn-main" style="background: var(--primary-dark);">
                                <i class="fa-solid fa-chart-pie"></i> التقرير الشامل للنظام
                            </button>
                        </div>
                        
                        <div id="tech-task-management" class="hidden" style="margin-top: 30px; border-top: 1px dashed var(--border-color); padding-top: 20px;">
                            <label style="font-weight: 800; color: var(--primary); margin-bottom: 15px; display: block; font-size: 14px;">
                                <i class="fa-solid fa-users-gear"></i> إدارة مهام الفنيين
                            </label>
                            <div style="background: var(--bg-body); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color);">
                                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">استخراج تقرير أداء لفني (عامل) معين:</p>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="sub-tech-name-input" placeholder="اسم الفني..." style="margin: 0;">
                                    <button onclick="generateSubTechReport()" class="btn-main btn-sm" style="width: auto;">
                                        <i class="fa-solid fa-file-invoice"></i> استخراج
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 30px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-sm);">
                            <span style="font-weight: 700; font-size: 13px;">الدعم الفني</span>
                            <a href="mailto:support@ryada.edu.eg" style="text-decoration: none; color: var(--primary); font-size: 12px; display: flex; align-items: center; gap: 6px; font-weight: bold; background: var(--bg-body); padding: 8px 15px; border-radius: 8px;">
                                 <i class="fa-solid fa-headset"></i> تواصل معنا
                            </a>
                        </div>

                        <hr style="border-color: var(--border-color); margin: 30px 0;">
                        
                        <button onclick="document.getElementById('logout-modal').classList.remove('hidden')" class="btn-main btn-danger">
                            تسجيل خروج آمن <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="nav('home', this)"><i class="fa-solid fa-list-check"></i>المهام</div>
            <div class="nav-item" onclick="nav('news', this)"><i class="fa-regular fa-newspaper"></i>البيان</div> 
            <div class="nav-add-btn" onclick="nav('create', null)"><i class="fa-solid fa-plus"></i></div>
            <div class="nav-item" onclick="nav('team', this)"><i class="fa-solid fa-users"></i>الفريق</div>
            <div class="nav-item" onclick="nav('profile', this)"><i class="fa-solid fa-user"></i>حسابي</div>
            <div class="nav-item" onclick="nav('settings', this)"><i class="fa-solid fa-gear"></i>الإعدادات</div>
        </div>
    </div>
    
    <div id="media-viewer" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 12000; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div class="close-btn" style="top: 30px; right: 30px; left: auto; background: rgba(255,255,255,0.2); color: white; border: none;" onclick="document.getElementById('media-viewer').classList.add('hidden')">
            <i class="fa-solid fa-xmark"></i>
        </div>
        <div id="media-content-container" style="max-width: 95%; max-height: 80vh; border-radius: 12px; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,0.5);"></div>
    </div>

    <div id="audio-player-modal" class="modal-overlay hidden" style="z-index: 12001;">
        <div class="modal-content" style="max-width: 340px; text-align: center; padding: 40px 20px;">
            <div class="close-btn" onclick="closeAudioPlayer()"><i class="fa-solid fa-xmark"></i></div>
            <div style="width: 80px; height: 80px; background: var(--primary-soft); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; font-size: 32px;">
                <i class="fa-solid fa-music"></i>
            </div>
            <h4 style="margin: 0 0 20px; color: var(--text-main); font-weight: 800;">تسجيل صوتي</h4>
            <audio id="modal-audio-player" controls style="width: 100%; border-radius: 20px; outline: none;"></audio>
        </div>
    </div>

    <div id="friend-profile-modal" class="modal-overlay hidden">
        <div class="modal-content" style="text-align: center; z-index: 2001;">
            <div class="close-btn" onclick="closeModal('friend-profile-modal')"><i class="fa-solid fa-xmark"></i></div>
            
            <div style="position: relative; margin-bottom: 20px; display: inline-block;">
                <img id="fp-pic" src="" style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--surface); object-fit: cover; box-shadow: var(--shadow-md);">
            </div>
            
            <h3 id="fp-name" style="margin: 0; font-size: 20px; font-weight: 900; color: var(--text-main);">User Name</h3>
            <span id="fp-role" style="background: var(--primary); color: white; padding: 4px 15px; border-radius: 20px; font-size: 11px; display: inline-block; margin: 10px 0 20px; font-weight: 700;">Role</span>
            
            <div id="fp-actions" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px;"></div>
            
            <div style="text-align: right; background: var(--bg-body); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color);">
                <p style="margin: 10px 0; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px;">
                    <i class="fa-solid fa-briefcase" style="color: var(--primary); width: 20px;"></i> <span id="fp-job" style="font-weight: 600;">-</span>
                </p>
                <p style="margin: 10px 0; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px;">
                    <i class="fa-solid fa-location-dot" style="color: var(--primary); width: 20px;"></i> <span id="fp-loc" style="font-weight: 600;">-</span>
                </p>
                <p style="margin: 10px 0;">
                    <i class="fa-solid fa-envelope" style="color: var(--primary); width: 20px;"></i> <span id="fp-email" style="font-size: 11px; font-family: sans-serif;">-</span>
                </p>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content" style="text-align: center; max-width: 320px;">
             <div style="width: 60px; height: 60px; margin: 0 auto 20px; background: #fee2e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--danger); font-size: 28px;">
                 <i class="fa-solid fa-triangle-exclamation"></i>
             </div>
             <h3 style="margin-bottom: 10px; color: var(--text-main); font-weight: 800;">تأكيد الإجراء</h3>
             <p id="confirm-modal-msg" style="color: var(--text-secondary); font-size: 13px; margin-bottom: 25px;">هل أنت متأكد؟</p>
             <div style="display: flex; gap: 10px;">
                 <button id="confirm-yes-btn" class="btn-main btn-danger btn-sm">نعم، تنفيذ</button>
                 <button onclick="closeModal('confirm-modal')" class="btn-ghost btn-sm" style="width: 100%;">إلغاء</button>
             </div>
        </div>
    </div>

    <div id="sup-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('sup-modal')"><i class="fa-solid fa-xmark"></i></div>
            <h3 style="margin-bottom: 20px; border-right: 4px solid var(--gold); padding-right: 12px; color: var(--text-main); font-size: 18px;">اختر المشرف</h3>
            <p style="font-size: 11px; color: var(--text-secondary); margin-bottom: 15px; background: var(--bg-body); padding: 8px; border-radius: 8px;">
                سيتم إرسال البلاغ إلى المشرف المختار للموافقة عليه.
            </p>
            <div id="sup-list" style="max-height: 250px; overflow-y: auto; margin-bottom: 20px; padding: 5px;"></div>
            <button onclick="sendRequestFinal()" class="btn-main btn-sm" id="confirm-send-btn">
                تأكيد وإرسال <i class="fa-regular fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div id="action-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('action-modal')"><i class="fa-solid fa-xmark"></i></div>
            <h3 id="act-title" style="margin-bottom: 20px; color: var(--text-main); font-weight: 900; font-size: 18px;">إجراء</h3>
            <textarea id="act-comment" rows="4" placeholder="اكتب ملاحظات، تعليمات، أو سبب الرفض..."></textarea>
            
            <div id="tech-select-area" class="hidden" style="margin-top: 20px;">
                <p style="font-size: 12px; font-weight: 700; color: var(--text-secondary); margin-bottom: 10px;">اختر المهندس المختص:</p>
                <div id="tech-list-action" class="tech-select-grid" style="max-height: 180px; overflow-y: auto; padding: 5px;"></div>
            </div>
            
            <div id="worker-select-area" class="hidden" style="margin-top: 20px;">
                <p style="font-size: 12px; font-weight: 700; color: var(--text-secondary); margin-bottom: 10px;">تعيين فني (عامل) للتنفيذ:</p>
                <div id="worker-list-action" class="tech-select-grid" style="max-height: 180px; overflow-y: auto; padding: 5px;"></div>
            </div>

            <button onclick="submitAction()" id="act-submit-btn" class="btn-main btn-sm" style="margin-top: 20px;">تأكيد</button>
        </div>
    </div>

    <div id="tech-report-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('tech-report-modal')"><i class="fa-solid fa-xmark"></i></div>
            <h3 style="margin-bottom: 20px; color: var(--primary-dark); font-weight: 800;">تقرير فني</h3>
            <div class="input-group">
                <input type="text" id="tech-report-title" placeholder="عنوان التقرير">
            </div>
            <div class="input-group">
                <textarea id="tech-report-content" rows="6" placeholder="تفاصيل التقرير..."></textarea>
            </div>
            <button onclick="submitTechReport()" class="btn-main btn-sm">
                <i class="fa-solid fa-file-pdf"></i> حفظ PDF
            </button>
        </div>
    </div>
    
    <div id="emp-report-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="close-btn" onclick="closeModal('emp-report-modal')"><i class="fa-solid fa-xmark"></i></div>
            <h3 style="margin-bottom: 20px; color: var(--primary);">تقرير إداري</h3>
            <div class="input-group"><input type="text" id="emp-rep-title" placeholder="عنوان التقرير"></div>
            <div class="input-group"><textarea id="emp-rep-content" rows="8" placeholder="نص التقرير..."></textarea></div>
            <button onclick="generateEmpReport()" class="btn-main btn-sm" style="margin-top: 15px;">
                <i class="fa-solid fa-print"></i> طباعة
            </button>
        </div>
    </div>

    <div id="request-details-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="close-btn" onclick="closeModal('request-details-modal')"><i class="fa-solid fa-xmark"></i></div>
            <h3 style="text-align: center; color: var(--primary); margin-bottom: 10px; font-weight: 800;">تفاصيل البلاغ</h3>
            
            <div id="req-ticket-display" style="text-align: center; margin-bottom: 20px;"></div>
            
            <div id="req-details-content"></div>
        </div>
    </div>

    <div id="logout-modal" class="modal-overlay hidden">
        <div class="modal-content" style="text-align: center;">
            <i class="fa-solid fa-right-from-bracket fa-2x" style="color: var(--danger); margin-bottom: 15px;"></i>
            <h3 style="color: var(--text-main); font-weight: 800; margin-bottom: 10px;">خروج؟</h3>
            <p style="color: var(--text-secondary); margin-bottom: 25px; font-size: 13px;">هل أنت متأكد من الخروج؟</p>
            <div style="display: flex; gap: 10px;">
                <button onclick="logout()" class="btn-main btn-danger btn-sm">نعم</button>
                <button onclick="closeModal('logout-modal')" class="btn-ghost btn-sm" style="width: 100%;">إلغاء</button>
            </div>
        </div>
    </div>
    
    <div id="delete-friend-modal" class="modal-overlay hidden">
        <div class="modal-content" style="text-align: center;">
            <div class="close-btn" onclick="closeModal('delete-friend-modal')"><i class="fa-solid fa-xmark"></i></div>
            <i class="fa-solid fa-user-xmark fa-2x" style="color: var(--text-secondary); margin-bottom: 15px;"></i>
            <h3 style="margin-bottom: 10px; color: var(--text-main);">حذف صديق؟</h3>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="confirmRemoveFriend()" class="btn-main btn-danger btn-sm">حذف</button>
                <button onclick="closeModal('delete-friend-modal')" class="btn-ghost btn-sm" style="width: 100%;">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="toast" style="position: fixed; top: 30px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 12px 30px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); z-index: 12000; display: none; font-size: 12px; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.3); font-family: 'Cairo'; backdrop-filter: blur(5px); min-width: 200px; text-align: center;"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    /**
     * =========================================================================
     * 1. CONFIGURATION & INITIALIZATION (تهيئة التطبيق)
     * =========================================================================
     */
    const firebaseConfig = {
        apiKey: "AIzaSyABwJfEkkbNB8GurZkyj67R8ksVNEXZ11I",
        authDomain: "ryadanur1-375a8.firebaseapp.com",
        projectId: "ryadanur1-375a8",
        storageBucket: "ryadanur1-375a8.firebasestorage.app",
        messagingSenderId: "858244114090",
        appId: "1:858244114090:web:42cee8e98e3984164392d3"
    };
    
    // Cloudinary Config
    const CLOUD_NAME = "djzfruh22"; 
    const CLOUD_PRESET = "udyvggup";

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- Global State ---
    let currentUser = null;
    let userData = null;
    let isLoginMode = true;
    let selectedSup = null;
    let currentTab = 'active'; 
    let requestsCache = [];
    let uploadQueue = []; 
    let tempActionData = {}; 
    let selectedTech = null;
    let selectedWorker = null; // للمهندس عند اختيار عامل
    let newProfilePicFile = null;
    let isFirstLoad = true;
    let currentFriendDocId = null;
    let selectedFrameClass = '';
    
    // --- Audio ---
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    /**
     * =========================================================================
     * 2. TICKET GENERATOR (NEW: 2 Chars + 2 Numbers)
     * =========================================================================
     * إنشاء كود فريد قصير: حرفين ورقمين (مثال: #XY25)
     */
    function generateTicketId() {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const nums = "0123456789";
        
        let c1 = chars.charAt(Math.floor(Math.random() * chars.length));
        let c2 = chars.charAt(Math.floor(Math.random() * chars.length));
        let n1 = nums.charAt(Math.floor(Math.random() * nums.length));
        let n2 = nums.charAt(Math.floor(Math.random() * nums.length));
        
        // التنسيق النهائي: #AB12
        return `#${c1}${c2}${n1}${n2}`;
    }

    /**
     * =========================================================================
     * 3. AUTHENTICATION & STARTUP
     * =========================================================================
     */
    auth.onAuthStateChanged(async u => {
        if(u) {
            if(!u.emailVerified) {
                document.getElementById('loader').classList.add('hidden');
                toast("⚠️ يجب تفعيل البريد الإلكتروني أولاً.");
                auth.signOut();
                showScreen('auth-screen');
                return;
            }
            currentUser = u;
            await loadUser();
        } else {
            document.getElementById('loader').classList.add('hidden');
            showScreen('auth-screen');
        }
    });

    async function loadUser() {
        try {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if(doc.exists) {
                userData = doc.data();
                
                // Legacy Fix
                if(!userData.shortId) {
                    userData.shortId = Math.random().toString(36).substr(2,6).toUpperCase();
                    await db.collection('users').doc(currentUser.uid).update({shortId: userData.shortId});
                }
                
                renderHeader();
                showScreen('app-container');
                setupRoleUI();
                
                // Data Loading
                loadFeed();
                loadTeam(); 
                loadFriendReqs();
                loadProfilePageData();
                loadPosts();
                
                // Defaults
                document.getElementById('req-date').valueAsDate = new Date();
                document.getElementById('req-time').value = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

                setTimeout(() => { document.getElementById('loader').classList.add('hidden'); }, 500);
            }
        } catch(e) { 
            console.error(e);
            document.getElementById('loader').classList.add('hidden');
            toast("⚠️ خطأ في تحميل البيانات"); 
        }
    }

    function setupRoleUI() {
        if(userData.role === 'supervisor') document.getElementById('filter-container').classList.remove('hidden');
        if(userData.role === 'employee') document.getElementById('emp-report-btn-container').classList.remove('hidden');
        
        if(userData.role === 'technician') {
            const addBtn = document.querySelector('.nav-add-btn');
            addBtn.innerHTML = '<i class="fa-solid fa-file-pdf"></i>';
            addBtn.onclick = function() { document.getElementById('tech-report-modal').classList.remove('hidden'); };
            document.getElementById('page-create').innerHTML = "<div style='text-align:center; padding:50px; color:#999;'><i class='fa-solid fa-helmet-safety fa-3x'></i><br><br>حساب مهندس<br>إدارة البلاغات</div>";
            document.getElementById('tech-task-management').classList.remove('hidden');
        }

        if(userData.role === 'worker') {
            document.querySelector('.nav-add-btn').classList.add('hidden'); 
            document.getElementById('page-create').innerHTML = "<div style='text-align:center; padding:50px; color:#999;'><i class='fa-solid fa-wrench fa-3x'></i><br><br>حساب فني<br>استلام المهام</div>";
        }

        if(userData.role === 'manager') {
             document.getElementById('create-post-container').classList.remove('hidden');
             document.getElementById('full-report-btn-container').classList.remove('hidden');
             document.querySelector('.nav-add-btn').classList.add('hidden');
        }
    }

    /**
     * =========================================================================
     * 4. UI RENDERING & FEED LOGIC
     * =========================================================================
     */
    function renderHeader() {
        const roleMap = {'employee':'موظف', 'supervisor':'مشرف', 'technician':'مهندس', 'manager':'مدير', 'worker':'فني'};
        document.getElementById('banner-name').innerText = userData.fullName;
        document.getElementById('banner-role').innerText = roleMap[userData.role] || userData.role;
        document.getElementById('banner-id').innerText = "ID: " + userData.shortId;
        document.getElementById('banner-img').src = userData.photoUrl;
        
        const frameEl = document.getElementById('banner-frame');
        frameEl.className = 'frame-overlay ' + (userData.frame || '');
    }

    function checkAndPlaySound(newRequests) {
        let shouldPlay = false;
        if(userData.role === 'supervisor' && newRequests.some(r=>r.status === 'pending')) shouldPlay=true;
        if(userData.role === 'technician' && newRequests.some(r=>r.status === 'approved')) shouldPlay=true;
        if(userData.role === 'worker' && newRequests.some(r=>r.status === 'assigned_to_worker')) shouldPlay=true;
        
        if (shouldPlay) {
            const audio = document.getElementById('notify-sound');
            if(audio) audio.play().catch(e => console.log("Blocked"));
            toast("🔔 إشعار جديد");
            document.querySelector('.bell-badge').style.display = 'block';
        }
    }

    function loadFeed() {
        let q = db.collection('requests'); 
        if(userData.role === 'employee') q = q.where('userId','==',currentUser.uid);
        else if(userData.role === 'supervisor') q = q.where('supervisorId','==',currentUser.uid);
        else if(userData.role === 'technician') q = q.where('technicianId','==',currentUser.uid);
        else if(userData.role === 'worker') q = q.where('workerId','==',currentUser.uid);
        
        q.onSnapshot(snap => {
            const currentIds = requestsCache.map(r => r.id);
            let newItems = [];
            let updatedCache = [];

            snap.forEach(doc => {
                const data = {id: doc.id, ...doc.data()};
                updatedCache.push(data);
                if (!isFirstLoad && !currentIds.includes(doc.id)) newItems.push(data);
            });

            requestsCache = updatedCache;
            requestsCache.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
            
            if(!isFirstLoad && newItems.length > 0) checkAndPlaySound(newItems);
            isFirstLoad = false;
            renderFeed();
        });
    }

    function renderFeed() {
        const container = document.getElementById('requests-feed'); container.innerHTML = "";
        let list = requestsCache;

        if(currentTab === 'trash') list = list.filter(r => r.isDeleted === true);
        else {
            list = list.filter(r => r.isDeleted !== true);
            if(currentTab === 'active') list = list.filter(r => ['pending','approved','working','assigned_to_worker','worker_accepted','suspended'].includes(r.status));
            else if(currentTab === 'history') list = list.filter(r => ['done','rejected'].includes(r.status));
        }

        const facFilter = document.getElementById('feed-filter').value;
        if(userData.role === 'supervisor' && facFilter !== 'all') list = list.filter(r => r.faculty === facFilter);

        if(list.length === 0) { 
            container.innerHTML = `<div style="text-align:center; padding:50px 20px; color:var(--text-secondary);"><i class="fa-regular fa-folder-open fa-3x" style="opacity:0.3; margin-bottom:10px;"></i><p>لا يوجد بيانات</p></div>`; 
            return; 
        }

        list.forEach(d => {
            let statusClass = '';
            if(['pending'].includes(d.status)) statusClass = 'st-bar-pending';
            else if(['done'].includes(d.status)) statusClass = 'st-bar-done';
            else if(['rejected'].includes(d.status)) statusClass = 'st-bar-rejected';
            else statusClass = 'st-bar-working';

            let statusText = getStatusLabel(d.status);
            
            let timeParts = d.time.split(':');
            let dateObj = new Date(); dateObj.setHours(timeParts[0]); dateObj.setMinutes(timeParts[1]);
            let timeDisplay = dateObj.toLocaleTimeString('ar-EG', {hour: 'numeric', minute:'numeric', hour12: true});

            let actionBtns = "";
            let deleteBtn = "";

            if(currentTab !== 'trash') {
                if(['employee','supervisor','manager'].includes(userData.role)) {
                      deleteBtn = `<button onclick="event.stopPropagation(); softDelete('${d.id}')" class="btn-ghost btn-sm" style="color:var(--danger); border-color:var(--border-color); margin-left:10px;"><i class="fa-solid fa-trash"></i></button>`;
                }

                // SUPERVISOR
                if(userData.role === 'supervisor' && d.status === 'pending') {
                    actionBtns = `
                    <div style="display:flex; gap:8px;">
                        <button onclick="event.stopPropagation(); openAction('${d.id}','approve')" class="btn-main btn-sm" style="background:var(--success);">قبول</button>
                        <button onclick="event.stopPropagation(); openAction('${d.id}','reject')" class="btn-main btn-danger btn-sm">رفض</button>
                    </div>`;
                }
                
                // ENGINEER
                else if(userData.role === 'technician') { 
                    if(d.status === 'approved') {
                        actionBtns = `
                        <div style="display:flex; gap:8px;">
                             <button onclick="event.stopPropagation(); openAction('${d.id}','assignWorker')" class="btn-main btn-sm">توجيه فني</button>
                             <button onclick="event.stopPropagation(); openAction('${d.id}','tech_reject')" class="btn-ghost btn-sm" style="color:var(--danger); border-color:var(--danger);">رفض</button>
                        </div>`;
                    } else if (d.status === 'worker_accepted') {
                         actionBtns = `<span style="font-size:10px; color:var(--warning); font-weight:bold;">جاري التنفيذ...</span>`;
                    }
                }

                // WORKER
                else if(userData.role === 'worker') {
                    if(d.status === 'assigned_to_worker') {
                        actionBtns = `
                        <div style="display:flex; gap:8px;">
                             <button onclick="event.stopPropagation(); openAction('${d.id}','worker_accept')" class="btn-main btn-sm" style="background:var(--success);">استلام</button>
                             <button onclick="event.stopPropagation(); openAction('${d.id}','worker_reject')" class="btn-ghost btn-sm" style="color:var(--danger);">رفض</button>
                        </div>`;
                    } else if (d.status === 'worker_accepted') {
                         actionBtns = `
                         <div style="display:flex; gap:8px;">
                             <button onclick="event.stopPropagation(); openAction('${d.id}','done')" class="btn-main btn-sm" style="background:var(--success);">تم</button>
                             <button onclick="event.stopPropagation(); openAction('${d.id}','not_done')" class="btn-ghost btn-sm" style="color:var(--danger);">مشكلة</button>
                         </div>`;
                    }
                }
            } else {
                actionBtns = `<div style="display:flex; gap:5px;"><button onclick="event.stopPropagation(); restoreReq('${d.id}')" class="btn-main btn-sm" style="background:var(--info);">استعادة</button><button onclick="event.stopPropagation(); hardDelete('${d.id}')" class="btn-ghost btn-sm" style="color:var(--danger);">حذف</button></div>`;
            }

            let prioBadge = d.priority === 'high' ? `<div class="tag tag-priority-high"><i class="fa-solid fa-fire"></i> عاجل</div>` : '';
            let workerInfo = d.workerName ? `<div style="font-size:11px; color:var(--text-secondary); margin-top:5px;"><i class="fa-solid fa-user-gear"></i> ${d.workerName}</div>` : '';

            container.innerHTML += `
            <div class="request-card" onclick="openRequestDetails('${d.id}')">
                <div class="card-status-bar ${statusClass}"></div>
                <div class="card-body">
                    <div class="card-header">
                        <div class="card-user-info">
                            <img src="${d.userData.photoUrl}" class="card-avatar">
                            <div class="card-meta">
                                <span class="user-name">${d.userData.fullName}</span>
                                <div class="ticket-code">${d.ticketId || '---'}</div>
                            </div>
                        </div>
                        <span class="tag" style="background:#f3f4f6;">${timeDisplay}</span>
                    </div>
                    
                    <div class="card-content">
                        <div class="request-desc">${d.description}</div>
                        <div class="card-tags">
                            <div class="tag"><i class="fa-solid fa-screwdriver"></i> ${d.type}</div>
                            <div class="tag"><i class="fa-solid fa-location-dot"></i> ${d.location}</div>
                            ${prioBadge}
                        </div>
                        ${workerInfo}
                    </div>
                    
                    <div class="card-footer">
                        <span style="font-size:12px; font-weight:700; color:var(--primary);">${statusText}</span>
                        <div style="display:flex; align-items:center;">${deleteBtn} ${actionBtns}</div>
                    </div>
                </div>
            </div>`;
        });
    }

    /**
     * =========================================================================
     * 5. ACTIONS & LOGIC
     * =========================================================================
     */
    async function openAction(id, type) {
        tempActionData = { id, type };
        document.getElementById('action-modal').classList.remove('hidden');
        const commBox = document.getElementById('act-comment');
        commBox.value = "";
        
        document.getElementById('tech-select-area').classList.add('hidden');
        document.getElementById('worker-select-area').classList.add('hidden');
        
        const titles = {
            'approve':'توجيه للمهندس', 'reject':'رفض الطلب', 
            'assignWorker':'توجيه للفني', 'tech_reject':'رفض (مهندس)',
            'worker_accept':'استلام المهمة', 'worker_reject':'رفض (فني)',
            'done':'إتمام', 'not_done':'تعذر الإصلاح'
        };
        document.getElementById('act-title').innerText = titles[type] || 'إجراء';

        if(type === 'approve') {
            document.getElementById('tech-select-area').classList.remove('hidden');
            loadUsersForAction('technician', 'tech-list-action');
        } else if (type === 'assignWorker') {
            document.getElementById('worker-select-area').classList.remove('hidden');
            loadUsersForAction('worker', 'worker-list-action');
        }
    }

    async function loadUsersForAction(role, elementId) {
        const list = document.getElementById(elementId); 
        list.innerHTML="<small>جاري التحميل...</small>";
        const snap = await db.collection('users').where('role','==',role).get();
        list.innerHTML="";
        if(snap.empty) { list.innerHTML = "<p style='font-size:11px; color:red;'>لا يوجد مستخدمين</p>"; return; }
        snap.forEach(doc => {
             const t = doc.data();
             const clickFn = role === 'technician' ? `selTech(this, '${doc.id}', '${t.fullName}')` : `selWorker(this, '${doc.id}', '${t.fullName}')`;
             list.innerHTML += `<div class="tech-select-card" onclick="${clickFn}"><img src="${t.photoUrl}"><div style="font-size:12px; font-weight:bold;">${t.fullName}</div></div>`;
        });
    }

    function selTech(el, id, name) {
        document.querySelectorAll('.tech-select-card').forEach(d=>d.classList.remove('selected'));
        el.classList.add('selected'); selectedTech={id, name};
    }
    function selWorker(el, id, name) {
        document.querySelectorAll('.tech-select-card').forEach(d=>d.classList.remove('selected'));
        el.classList.add('selected'); selectedWorker={id, name};
    }

    async function submitAction() {
        const { id, type } = tempActionData;
        const comment = document.getElementById('act-comment').value;
        const btn = document.getElementById('act-submit-btn');

        if((type.includes('reject') || type === 'not_done') && !comment) return toast("⚠️ يجب ذكر السبب");
        if(type==='approve' && !selectedTech) return toast("⚠️ اختر مهندساً");
        if(type==='assignWorker' && !selectedWorker) return toast("⚠️ اختر فنياً");

        btn.disabled=true; btn.innerText = "...";
        try {
            let updateData = {};
            if(type === 'approve') { updateData={status:'approved', technicianId:selectedTech.id, technicianName:selectedTech.name, supervisorComment:comment}; }
            else if(type === 'reject') { updateData={status:'rejected', rejectedBy:userData.fullName, supervisorComment:comment}; }
            else if(type === 'assignWorker') { updateData={status:'assigned_to_worker', workerId:selectedWorker.id, workerName:selectedWorker.name, engineerComment:comment}; }
            else if(type === 'tech_reject') { updateData={status:'rejected', rejectedBy:`المهندس: ${userData.fullName}`, supervisorComment:comment}; }
            else if(type === 'worker_accept') { updateData={status:'worker_accepted'}; }
            else if(type === 'worker_reject') { updateData={status:'rejected', rejectedBy:`الفني: ${userData.fullName}`, workerComment:comment}; }
            else if(type === 'done') { updateData={status:'done', completedAt:firebase.firestore.FieldValue.serverTimestamp(), workerComment:comment}; }
            else if(type === 'not_done') { updateData={status:'suspended', workerComment:`تعذر: ${comment}`}; }

            await db.collection('requests').doc(id).update(updateData);
            toast("✅ تم"); closeModal('action-modal');
        } catch(e) { console.error(e); } finally { btn.disabled=false; btn.innerText="تأكيد"; }
    }

    /**
     * =========================================================================
     * 6. CREATE REQUEST
     * =========================================================================
     */
    async function sendRequestFinal() { 
        if(!selectedSup) return toast("⚠️ اختر مشرف");
        const btn=document.getElementById('confirm-send-btn'); btn.disabled=true; btn.innerText="...";
        try { 
            let mediaLinks = [];
            for(const file of uploadQueue) {
                const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', CLOUD_PRESET);
                if(file.type.startsWith('audio')) fd.append('resource_type', 'video'); 
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method:'POST', body:fd});
                const d = await res.json();
                mediaLinks.push({url: d.secure_url, type: file.type.startsWith('video')?'video':(file.type.startsWith('audio')?'audio':'image')});
            }
            
            const facSelect = document.getElementById('req-faculty');
            const facText = facSelect.options[facSelect.selectedIndex].text;
            const floor = document.getElementById('req-floor').value;
            const room = document.getElementById('req-room').value;
            const loc = `${facText}`;
            
            // Generate Ticket ID (2 Chars + 2 Nums)
            const ticketId = generateTicketId();

            await db.collection('requests').add({ 
                ticketId: ticketId,
                userId:currentUser.uid, 
                userData:{ fullName:userData.fullName, photoUrl:userData.photoUrl }, 
                supervisorId:selectedSup, 
                status:'pending', 
                type: document.getElementById('req-type').value,
                priority: document.querySelector('input[name="prio"]:checked').value,
                time: document.getElementById('req-time').value, 
                date: document.getElementById('req-date').value, 
                description: document.getElementById('req-desc').value, 
                location: loc,
                faculty: facSelect.value,
                floor: floor,
                room: room,
                media: mediaLinks,
                isDeleted: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp() 
            }); 
            
            toast(`✅ تم الإرسال. كود: ${ticketId}`); closeModal('sup-modal'); 
            nav('home', document.querySelector('.nav-item:first-child'));
            uploadQueue=[]; document.getElementById('preview-grid').innerHTML=""; document.getElementById('req-desc').value="";
            document.getElementById('req-room').value = "";
        } catch(e){console.error(e);} finally{btn.disabled=false; btn.innerText="تأكيد";} 
    }

    async function openSupModal() { 
        if(!document.getElementById('req-desc').value || !document.getElementById('req-type').value || !document.getElementById('req-faculty').value || !document.getElementById('req-floor').value || !document.getElementById('req-room').value) return toast("⚠️ أكمل جميع البيانات");
        
        document.getElementById('sup-modal').classList.remove('hidden'); 
        const l=document.getElementById('sup-list'); 
        l.innerHTML="<p style='text-align:center'>جاري التحميل...</p>"; 
        
        const snap = await db.collection('users').where('role','==','supervisor').get();
        l.innerHTML="";
        
        const friendsSnap = await db.collection('users').doc(currentUser.uid).collection('friends').get();
        const friendIds = friendsSnap.docs.map(doc => doc.data().friendId);

        let count = 0;
        snap.forEach(d=>{ 
            if(friendIds.includes(d.id)) { 
                const u=d.data(); 
                l.innerHTML+=`<div onclick="selectSup(this, '${d.id}')" style="display:flex; align-items:center; gap:10px; padding:10px; border:1px solid #eee; margin-bottom:5px; border-radius:10px; cursor:pointer;"><img src="${u.photoUrl}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;"><b>${u.fullName}</b></div>`;
                count++;
            }
        }); 
        if(count === 0) l.innerHTML = "<p style='text-align:center; font-size:12px;'>لا يوجد مشرفين في الأصدقاء.</p>";
    }
    
    function selectSup(el, id) { 
        document.querySelectorAll('#sup-list div').forEach(d=>{d.style.background='transparent';});
        el.style.background='#eff6ff'; selectedSup=id; 
    }

    // UTILS
    function getStatusLabel(s) {
        const map = { 'pending': 'في الانتظار', 'approved': 'مقبول', 'assigned_to_worker': 'جاري العمل', 'worker_accepted': 'قيد التنفيذ', 'done': 'مكتمل', 'rejected': 'مرفوض', 'suspended': 'معلق' };
        return map[s] || s;
    }

    function openRequestDetails(id) {
        const d = requestsCache.find(r => r.id === id);
        document.getElementById('request-details-modal').classList.remove('hidden');
        document.getElementById('req-ticket-display').innerHTML = `<div class="ticket-badge" style="font-size:20px; padding:10px 20px;">${d.ticketId || '---'}</div>`;
        
        let timeline = `<div class="timeline">
            <div class="timeline-item ${['pending','approved','assigned_to_worker','worker_accepted','done'].includes(d.status)?'active':''}"><div class="tl-icon">1</div><div class="tl-content"><h4>إرسال</h4></div></div>
            <div class="timeline-item ${['approved','assigned_to_worker','worker_accepted','done'].includes(d.status)?'active':''}"><div class="tl-icon">2</div><div class="tl-content"><h4>موافقة</h4></div></div>
            <div class="timeline-item ${['assigned_to_worker','worker_accepted','done'].includes(d.status)?'active':''}"><div class="tl-icon">3</div><div class="tl-content"><h4>تنفيذ</h4></div></div>
            <div class="timeline-item ${['done'].includes(d.status)?'active':''}"><div class="tl-icon">4</div><div class="tl-content"><h4>إتمام</h4></div></div>
        </div>`;
        
        document.getElementById('req-details-content').innerHTML = `
            ${timeline}
            <div style="background:#f9fafb; padding:15px; border-radius:12px; margin-bottom:15px;"><b>الوصف:</b> ${d.description}</div>
            <div style="font-size:12px;">الموقع: ${d.location} | الدور: ${d.floor} | ق: ${d.room}</div>
            <button onclick="downloadSinglePDF('${d.id}')" class="btn-main btn-sm" style="margin-top:20px;">تحميل PDF</button>
        `;
    }

    // Rest of helper functions (Auth, Tabs, Media, Toast) remain similar but optimized
    function toggleAuth() { isLoginMode=!isLoginMode; document.getElementById('reg-fields').classList.toggle('hidden'); document.getElementById('confirm-pass-field').classList.toggle('hidden'); document.getElementById('auth-btn').innerText=isLoginMode?"دخول":"إنشاء حساب"; }
    function switchTab(t,e) { currentTab=t; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); e.classList.add('active'); renderFeed(); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function toast(m) { const t=document.getElementById('toast'); t.innerHTML=m; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
    function nav(p,el) { document.querySelectorAll('.page-section').forEach(x=>x.classList.add('hidden')); document.getElementById('page-'+p).classList.remove('hidden'); if(el){document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active');} }
    function showScreen(id) { ['auth-screen','app-container'].forEach(x=>document.getElementById(x).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function logout() { auth.signOut(); location.reload(); }
    
    // Auth & Profile Logic are standard...
    // (Codes for saveProfile, loadProfilePageData, searchUser, addFriend are included in logic flow)
</script>
</body>
</html> 
